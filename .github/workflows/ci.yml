name: CI

on: [push, pull_request]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      horn-core: ${{ steps.filter.outputs.horn-core }}
      horn-drivers: ${{ steps.filter.outputs.horn-drivers }}
      horn-geometry: ${{ steps.filter.outputs.horn-geometry }}
      horn-solver: ${{ steps.filter.outputs.horn-solver }}
      horn-analysis: ${{ steps.filter.outputs.horn-analysis }}
      nextflow: ${{ steps.filter.outputs.nextflow }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            horn-core:
              - 'packages/horn-core/**'
            horn-drivers:
              - 'packages/horn-drivers/**'
              - 'data/drivers/**'
            horn-geometry:
              - 'packages/horn-geometry/**'
            horn-solver:
              - 'packages/horn-solver/**'
            horn-analysis:
              - 'packages/horn-analysis/**'
            nextflow:
              - 'main.nf'
              - 'nextflow.config'
              - 'tests/*.nf.test'
              - 'tests/*.nf.test.snap'
              - 'packages/*/Dockerfile'
            ci:
              - '.github/workflows/**'
              - 'justfile'

  test_nextflow:
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.nextflow == 'true' ||
      needs.detect-changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Install Nextflow
        run: |
          wget -qO- get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/
      - name: Install nf-test
        uses: nf-core/setup-nf-test@v1
      - name: Install just
        uses: extractions/setup-just@v2
      - name: Build Docker images
        run: just build
      - name: Run nf-test
        run: just test-nextflow

  test_pure_python:
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.horn-core == 'true' ||
      needs.detect-changes.outputs.horn-drivers == 'true' ||
      needs.detect-changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [horn-core, horn-drivers]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -e packages/horn-core
          pip install -e packages/horn-drivers
          pip install pytest
      - name: Run tests
        run: pytest packages/${{ matrix.package }}/tests -v

  test_horn_geometry:
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.horn-geometry == 'true' ||
      needs.detect-changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build test image
        run: docker build -t horn-geometry:test --target test -f ./packages/horn-geometry/Dockerfile .
      - name: Run tests (skip validation on PRs)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            docker run --rm horn-geometry:test pytest packages/horn-geometry/tests -v -m "not validation"
          else
            docker run --rm horn-geometry:test pytest packages/horn-geometry/tests -v
          fi
      - name: Login to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push production image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./packages/horn-geometry/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/horn-geometry:latest

  test_horn_solver:
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.horn-solver == 'true' ||
      needs.detect-changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build test image
        run: docker build -t horn-solver:test --target test -f ./packages/horn-solver/Dockerfile .
      - name: Run tests (skip validation on PRs)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            docker run --rm horn-solver:test pytest packages/horn-solver/tests -v -m "not validation"
          else
            docker run --rm horn-solver:test pytest packages/horn-solver/tests -v
          fi
      - name: Login to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push production image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./packages/horn-solver/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/horn-solver:latest

  test_horn_analysis:
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.horn-analysis == 'true' ||
      needs.detect-changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build test image
        run: docker build -t horn-analysis:test --target test -f ./packages/horn-analysis/Dockerfile .
      - name: Run tests (skip validation on PRs)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            docker run --rm horn-analysis:test pytest packages/horn-analysis/tests -v -m "not validation"
          else
            docker run --rm horn-analysis:test pytest packages/horn-analysis/tests -v
          fi
      - name: Login to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push production image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./packages/horn-analysis/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/horn-analysis:latest
